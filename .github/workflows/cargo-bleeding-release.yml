# Runs on push to main.
name: Cargo Bleeding Release

on:
  push:
    branches: 
      - 'main'

concurrency:
  group: bleeding-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    uses: ./.github/workflows/cargo-build.yml
    with:
      version: ${{ needs.extract_tag.outputs.version }}

  bleeding-release:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: qpm-*
          path: artifacts

      - name: Delete bleeding tag
        run: |
          git push -d origin bleeding || true

      # Give GitHub time to delete the old release
      - name: Sleep
        run: sleep 10
        
      - name: Bleeeding Artifact Upload
        uses: softprops/action-gh-release@v1
        with:
          body: |
            This is an automatic release generated from the last successful commit to the main branch.  While this was a successful build, the resulting binary may not be fully stable.

            SHA: ${{ github.sha }}
          name: 'Latest Build on main'
          tag_name: bleeding
          prerelease: true
          files: artifacts/**/*
